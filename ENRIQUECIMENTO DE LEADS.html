<!DOCTYPE html>
<html lang="pt-BR" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chosen Palette: Warm Neutrals - Slate & Muted Blue -->
    <!-- Application Structure Plan: A dashboard-style portal with six main cards: 1) Leads Directory, 2) Lead Registration, 3) Lead Qualification (with CNPJ search and CNAE validation), 4) Market Analysis, 5) AI Chatbots, 6) Data Visualizations. This version introduces a dedicated card for lead qualification and manual entry, and robust error handling. -->
    <!-- Visualization & Content Choices: Content is now segmented into the six cards. CNPJ validation and Chatbots are new. All features use Gemini API. OpenAI calls are structured but depend on a secure environment. Defensive rendering is added to prevent crashes from malformed API responses. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Portal de Intelig√™ncia de Vendas com IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dashboard-card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; display: flex; flex-direction: column; }
        .modal-enter { transition: opacity 0.3s ease; }
        .modal-leave { transition: opacity 0.3s ease; }
        .modal-enter-from, .modal-leave-to { opacity: 0; }
        .modal-enter-to, .modal-leave-from { opacity: 1; }
        .prose-custom { color: #334155; }
        .prose-custom h3, .prose-custom h4 { color: #1e293b; font-weight: 600; margin-bottom: 0.5rem; }
        .prose-custom ul { list-style-position: outside; padding-left: 1.25rem; }
        .prose-custom li::marker { color: #64748b; }
        .prose-custom p, .prose-custom li { margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .prose-custom strong { font-weight: 600; color: #1e293b; }
        .loader { width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-dark { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .toast { position: fixed; top: 20px; right: 20px; background-color: #22c55e; color: white; padding: 1rem; border-radius: 0.5rem; z-index: 1000; transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out; transform: translateX(120%); opacity: 0;}
        .toast.show { transform: translateX(0); opacity: 1;}
        .toast.error { background-color: #ef4444; }
        .tab-button { padding: 0.5rem 1rem; border-bottom: 2px solid transparent; transition: all 0.2s ease-in-out; }
        .tab-button.active { border-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <h1 class="text-xl md:text-2xl font-bold text-slate-900">Portal de Intelig√™ncia de Vendas</h1>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 md:py-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            
            <div class="dashboard-card lg:col-span-3">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Diret√≥rio de Leads</h2>
                <div class="mb-4 max-w-xl mx-auto space-y-4">
                     <div class="relative"><div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"><svg class="h-5 w-5 text-slate-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" /></svg></div><input type="text" id="searchInput" class="block w-full rounded-md border-0 bg-white py-3 pl-10 pr-3 text-slate-900 ring-1 ring-inset ring-slate-300 placeholder:text-slate-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm" placeholder="Buscar por nome do grupo..."></div>
                </div>
                <div id="group-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6 overflow-y-auto max-h-[50vh] p-2"></div>
            </div>

            <div class="dashboard-card">
                 <h2 class="text-2xl font-bold text-slate-900 mb-4">Cadastro de Leads</h2>
                 <p class="text-sm text-slate-600 mb-4">Adicione um novo lead diretamente ao diret√≥rio.</p>
                 <div class="space-y-4">
                    <input type="text" id="manual-name" class="block w-full rounded-md border-slate-300 shadow-sm" placeholder="Nome do Grupo">
                    <input type="text" id="manual-phone" class="block w-full rounded-md border-slate-300 shadow-sm" placeholder="Telefone Principal">
                    <input type="text" id="manual-website" class="block w-full rounded-md border-slate-300 shadow-sm" placeholder="Website">
                    <div class="text-center">
                        <button id="manual-add-btn" class="inline-flex items-center gap-x-2 rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">Adicionar Lead</button>
                    </div>
                 </div>
            </div>

            <div class="dashboard-card">
                 <h2 class="text-2xl font-bold text-slate-900 mb-4">Qualifica√ß√£o de Leads</h2>
                 <p class="text-sm text-slate-600 mb-4">Consulte um CNPJ para buscar dados e validar o CNAE do lead.</p>
                 <div class="space-y-4">
                    <input type="text" id="cnpj-input" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Digite o CNPJ">
                    <div class="text-center">
                        <button id="consult-cnpj-btn" class="inline-flex items-center gap-x-2 rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">Consultar e Validar</button>
                    </div>
                    <div id="consultation-result" class="mt-4"></div>
                 </div>
            </div>
            
            <div class="dashboard-card">
                 <h2 class="text-2xl font-bold text-slate-900 mb-4">An√°lise de Mercado</h2>
                 <div class="space-y-4 flex-grow overflow-y-auto">
                    <div class="text-center mb-4">
                         <button id="generate-market-summary-btn" class="inline-flex items-center gap-x-2 rounded-md bg-teal-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-teal-500 transition-colors">üìä Gerar Resumo Executivo</button>
                    </div>
                    <div id="market-summary-container" class="text-sm prose-custom max-w-none hidden"></div>
                 </div>
            </div>

            <div class="dashboard-card lg:col-span-2">
                 <h2 class="text-2xl font-bold text-slate-900 mb-4">Prospec√ß√£o com IA</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Gemini Chat -->
                    <div class="space-y-2">
                        <label for="gemini-chat-input" class="text-sm font-medium text-slate-700 block">Chat com Gemini</label>
                        <textarea id="gemini-chat-input" rows="3" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Pergunte ao Gemini..."></textarea>
                        <button onclick="handleChatSubmit('gemini')" class="inline-flex items-center gap-x-2 rounded-md bg-blue-500 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-blue-400">Enviar</button>
                        <div id="gemini-chat-response" class="mt-2 text-sm p-2 bg-slate-50 rounded-md border max-h-40 overflow-y-auto"></div>
                    </div>
                     <!-- OpenAI Chat -->
                    <div class="space-y-2">
                        <label for="openai-chat-input" class="text-sm font-medium text-slate-700 block">Chat com ChatGPT (OpenAI)</label>
                        <textarea id="openai-chat-input" rows="3" class="block w-full rounded-md border-slate-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="Pergunte ao ChatGPT..."></textarea>
                        <button onclick="handleChatSubmit('openai')" class="inline-flex items-center gap-x-2 rounded-md bg-gray-800 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-gray-700">Enviar</button>
                        <div id="openai-chat-response" class="mt-2 text-sm p-2 bg-slate-50 rounded-md border max-h-40 overflow-y-auto"></div>
                    </div>
                 </div>
            </div>
            
            <div class="dashboard-card lg:col-span-3">
                <h2 class="text-2xl font-bold text-slate-900 mb-4">Visualiza√ß√µes de Dados</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 flex-grow">
                    <div class="flex flex-col items-center">
                        <h3 class="text-lg font-semibold mb-2 text-slate-800">PDVs por Grupo (Top 15)</h3>
                        <div class="w-full h-80"><canvas id="pdvCountChart"></canvas></div>
                    </div>
                     <div class="flex flex-col items-center">
                        <h3 class="text-lg font-semibold mb-2 text-slate-800">Representa√ß√£o de Marcas</h3>
                        <div class="w-full h-80"><canvas id="brandDistChart"></canvas></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4 modal-enter modal-enter-from" role="dialog" aria-modal="true">
        <div id="modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col transform transition-all"></div>
    </div>
    <div id="toast-notification" class="toast"></div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let groupsData = [
                {id: crypto.randomUUID(), groupName: 'GRUPO AMAZONAS', mainPhone: '1136741000', pdvs: [], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GRUPO BARIGUI', mainPhone: '4330258800', mainWebsite: 'https://www.fiatbarigui.com.br/', pdvs: [{ name: 'Fiat Barigui', website: 'https://www.fiatbarigui.com.br/' },{ name: 'Volkswagen Barigui', website: 'https://www.vwbarigui.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Destaque', mainPhone: '1147957700', mainWebsite: 'https://destaquetoyota.com.br/', pdvs: [{ name: 'Destaque Toyota Campinas', phone: '(19) 3705-7700', website: 'https://destaquetoyota.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo EUROBIKE', mainPhone: '1621327800', mainWebsite: 'https://www.eurobikebmw.com.br/', pdvs: [{ name: 'BMW Campinas Eurobike', phone: '(19) 3255-8788', website: 'https://www.eurobikebmw.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GRUPO EUROPAMOTORS', mainPhone: '1147501460', mainWebsite: 'https://www.europamotorsmercedes.com.br/', pdvs: [{ name: 'Europamotors Mercedes-Benz - S√£o Paulo', phone: '(11) 5099-9999', website: 'https://www.europamotorsmercedes.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GRUPO FORAUTO', mainPhone: '4834616000', mainWebsite: 'https://ford.grupoforauto.com.br/', pdvs: [{ name: 'Forauto Crici√∫ma (Ford)', phone: '(48) 3461-6000', website: 'https://ford.grupoforauto.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Geracao', mainPhone: '4832980000', mainWebsite: 'https://www.geracaochery.com.br/', pdvs: [{ name: 'Gera√ß√£o Caoa Chery Tubar√£o', phone: '(48) 3513-4200', website: 'https://www.geracaochery.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo GRANDAY', mainPhone: '1147502814', mainWebsite: 'https://www.grandayhb.com.br/', pdvs: [{ name: 'Granday Mooca (Hyundai)', phone: '(11) 4750-1251', website: 'https://www.grandayhb.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo LE LAC', mainPhone: '4133302500', mainWebsite: 'https://www.grupolelac.com.br/', pdvs: [{ name: 'Le Lac Francisco Beltr√£o (Jeep)', phone: '(46) 3151-1050', website: 'https://www.grupolelac.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Lince', mainPhone: '6236214545', mainWebsite: 'https://www.lincetoyota.com.br/', pdvs: [{ name: 'Lince Toyota - Bueno (Goi√¢nia)', phone: '(62) 3621-4545', website: 'https://www.lincetoyota.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Monvep', mainPhone: '3832246100', mainWebsite: 'https://monvep.com.br/', pdvs: [{ name: 'Monvep - Montes Claros (VW)', phone: '(38) 3224-6100', website: 'https://monvep.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo OSTEN', mainPhone: '1120908888', mainWebsite: 'https://www.ostengroup.com.br/', pdvs: [{ name: 'BMW Osten S√£o Jos√© dos Campos', phone: '(12) 3199-1717', website: 'https://www.ostenmotors.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GRUPO OURICAR', mainPhone: '1433025844', mainWebsite: 'https://www.ouricarchevrolet.com.br/', pdvs: [{ name: 'Ouricar Chevrolet - Santa Cruz do Rio Pardo e Ourinhos', phone: '+55 (14) 99746-7793 (WA)', website: 'https://www.ouricarchevrolet.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GRUPO PARAGUASSU', mainPhone: '7536029999', mainWebsite: 'https://www.paraguassuchevrolet.com.br/', pdvs: [{ name: 'Paraguassu Chevrolet (Alagoinhas, Feira, etc)', phone: '+55 (75) 9256-3311 (WA)', website: 'https://www.paraguassuchevrolet.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Ritmo', mainPhone: '1935653000', mainWebsite: 'https://www.ritmosp.com.br/', pdvs: [{ name: 'Ritmo SP Chevrolet - Batatais', phone: '+55 (16) 3661-5200', website: 'https://www.ritmosp.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'Grupo Santapedra', mainPhone: '4933218888', mainWebsite: 'https://www.santapedra.com.br/', pdvs: [{ name: 'Santapedra Volkswagen (S√£o Miguel do Oeste e outras)', website: 'https://www.santapedra.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'GUAIBACAR', mainPhone: '5130272000', mainWebsite: 'https://www.guaibacar.com.br/', pdvs: [{ name: 'Guaibacar - Sert√≥rio (Porto Alegre, VW)', phone: '(51) 3027-2000', website: 'https://www.guaibacar.com.br/' }], createdAt: new Date().toISOString()},
                {id: crypto.randomUUID(), groupName: 'LUMIERE', mainPhone: '1836073377', mainWebsite: 'https://www.lumierecitroen.com.br/', pdvs: [{ name: 'Lumi√®re Citro√´n - S√£o Jos√© do Rio Preto', phone: '(17) 3214-7733', website: 'https://www.lumierecitroen.com.br/' }], createdAt: new Date().toISOString()}
            ];
            
            const ui = {
                groupGrid: document.getElementById('group-grid'), searchInput: document.getElementById('searchInput'),
                modalContainer: document.getElementById('modal-container'), modalContent: document.getElementById('modal-content'),
                enrichAllBtn: document.getElementById('enrich-all-btn'),
                marketSummaryBtn: document.getElementById('generate-market-summary-btn'), marketSummaryContainer: document.getElementById('market-summary-container'),
                toast: document.getElementById('toast-notification'),
                consultBtn: document.getElementById('consult-cnpj-btn'),
                consultationResult: document.getElementById('consultation-result'),
                manualAddBtn: document.getElementById('manual-add-btn'),
            };

            const ALLOWED_CNAES = [
                '4511101', '4511102', '4511103', '4511104', '4511105', '4511106',
                '4512901', '4512902', '4541201', '4541203', '4541204', '7711000', '7719599'
            ];

            const showToast = (message, isError = false) => {
                ui.toast.textContent = message;
                ui.toast.className = `toast show ${isError ? 'error' : ''}`;
                setTimeout(() => { ui.toast.classList.remove('show'); }, 3000);
            }

            const renderGroups = (groups) => {
                ui.groupGrid.innerHTML = '';
                if (groups.length === 0) { ui.groupGrid.innerHTML = `<p class="text-slate-500 col-span-full text-center">Nenhum grupo encontrado.</p>`; return; }
                groups.forEach(group => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-6 cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col justify-between';
                    card.innerHTML = `<div><h3 class="font-bold text-lg text-slate-900 truncate">${group.groupName}</h3><p class="text-sm text-slate-500">${group.mainPhone ? 'üìû ' + group.mainPhone : ' '}</p></div><div class="mt-4 text-right"><span class="text-sm font-medium text-blue-600">Ver detalhes &rarr;</span></div>`;
                    card.addEventListener('click', () => openModal(group));
                    ui.groupGrid.appendChild(card);
                });
            };

            const openModal = (group) => {
                ui.modalContent.innerHTML = `
                    <div class="p-6 border-b border-slate-200 flex justify-between items-start">
                        <div><h2 class="text-2xl font-bold text-slate-900">${group.groupName}</h2></div>
                        <button id="close-modal-btn" class="p-1 rounded-full text-slate-400 hover:bg-slate-100"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                    </div>
                    <div class="p-6 flex-grow overflow-y-auto" id="modal-main-content">
                        <div class="border-b border-slate-200 mb-4">
                            <nav class="-mb-px flex space-x-6" id="modal-tabs">
                                <button data-tab="prospeccao" class="tab-button active">Prospec√ß√£o</button>
                                <button data-tab="analise" class="tab-button">An√°lise</button>
                            </nav>
                        </div>
                        <div id="tab-content-prospeccao" class="tab-content active"><div id="sales-kit-container" class="space-y-6"><button id="generate-sales-kit-btn" class="inline-flex items-center gap-x-2 rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500">üöÄ Gerar Kit de Prospec√ß√£o</button><div id="sales-kit-content" class="mt-4 prose-custom max-w-none"></div></div></div>
                        <div id="tab-content-analise" class="tab-content"><div class="space-y-6">
                            <div><h3 class="font-semibold text-lg mb-2 text-slate-800">Enriquecimento de Dados</h3><div id="ai-enrichment-container"><button id="enrich-lead-btn" class="inline-flex items-center gap-x-2 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">üîç Enriquecer Dados</button><div id="ai-enrichment-content" class="mt-4"></div></div></div>
                            <div class="border-t border-slate-200 pt-6"><h3 class="font-semibold text-lg mb-2 text-slate-800">An√°lise Estrat√©gica</h3><div id="ai-analysis-container"><button id="generate-ai-analysis-btn" class="inline-flex items-center gap-x-2 rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">‚ú® Gerar An√°lise</button><div id="ai-analysis-content" class="mt-4 prose-custom max-w-none"></div></div></div>
                            <div class="border-t border-slate-200 pt-6"><h3 class="font-semibold text-lg mb-2 text-slate-800">An√°lise de Concorr√™ncia</h3><div id="ai-competitor-container"><button id="competitor-analysis-btn" class="inline-flex items-center gap-x-2 rounded-md bg-amber-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-amber-500">‚öîÔ∏è Analisar</button><div id="ai-competitor-content" class="mt-4"></div></div></div>
                        </div></div>
                    </div>`;
                ui.modalContainer.classList.remove('hidden');
                ui.modalContainer.classList.add('flex');
                document.body.style.overflow = 'hidden';
                
                setTimeout(() => { ui.modalContainer.classList.remove('modal-enter-from'); }, 10);
                
                document.getElementById('close-modal-btn').addEventListener('click', closeModal);
                setupTabs('#modal-tabs .tab-button', '#modal-main-content .tab-content');

                handleCachedData(group, 'salesKit', 'sales-kit-container', 'generate-sales-kit-btn', renderSalesKit, generateSalesKit);
                handleCachedData(group, 'enrichmentData', 'ai-enrichment-container', 'enrich-lead-btn', renderEnrichmentData, enrichLead);
                handleCachedData(group, 'strategicAnalysis', 'ai-analysis-container', 'generate-ai-analysis-btn', renderStrategicSummary, generateStrategicSummary);
                handleCachedData(group, 'competitorAnalysis', 'ai-competitor-container', 'competitor-analysis-btn', renderCompetitors, generateCompetitorAnalysis);
            };
            
            const setupTabs = (tabsSelector, contentsSelector) => {
                const tabs = document.querySelectorAll(tabsSelector);
                const contents = document.querySelectorAll(contentsSelector);
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        contents.forEach(c => c.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(`tab-content-${tab.dataset.tab}`).classList.add('active');
                    });
                });
            };

            const handleCachedData = (group, dataKey, containerId, buttonId, renderFn, generateFn) => {
                const container = document.getElementById(containerId);
                const button = document.getElementById(buttonId);
                if (group[dataKey]) {
                    renderFn(group[dataKey], container.querySelector('div'));
                    if (button) button.style.display = 'none';
                } else {
                    if (button) button.addEventListener('click', () => generateFn(group));
                }
            };
            
            const closeModal = () => {
                ui.modalContainer.classList.add('modal-leave-to');
                document.body.style.overflow = '';
                setTimeout(() => { ui.modalContainer.classList.add('hidden'); ui.modalContainer.classList.remove('flex', 'modal-leave-to'); }, 300);
            };
            
            const simpleMarkdownToHtml = (text) => (text || '').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

            const callAIApi = async (engine, prompt, schema = null) => {
                const GEMINI_API_KEY = "";
                const OPENAI_API_KEY = "";
                let apiKey, apiUrl, payload;

                if (engine === 'gemini') {
                    apiKey = GEMINI_API_KEY;
                    apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                    if (schema) { payload.generationConfig = { responseMimeType: "application/json", responseSchema: schema }; }
                } else { // OpenAI
                    apiKey = OPENAI_API_KEY;
                    apiUrl = 'https://api.openai.com/v1/chat/completions'; 
                    payload = { model: "gpt-3.5-turbo", messages: [{"role": "user", "content": prompt}] };
                    if (schema) { payload.response_format = { "type": "json_object" }; }
                }
                
                const headers = { 'Content-Type': 'application/json' };
                if (engine === 'openai') { headers['Authorization'] = `Bearer ${apiKey}`; }

                const response = await fetch(apiUrl, { method: 'POST', headers: headers, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    const errorBody = await response.text();
                    console.error("API Error Response:", errorBody);
                    throw new Error(`API Error (${engine}): ${response.statusText || 'Something went wrong'}`); 
                }
                
                const result = await response.json();

                if(engine === 'gemini') {
                    if (result.candidates?.[0]?.content?.parts?.[0]) {
                        const rawText = result.candidates[0].content.parts[0].text;
                        return schema ? JSON.parse(rawText) : rawText;
                    }
                    if (result.promptFeedback?.blockReason) { throw new Error(`API blocked prompt: ${result.promptFeedback.blockReason}`); }
                } else { // OpenAI
                    if(result.choices?.[0]?.message?.content) {
                        const rawText = result.choices[0].message.content;
                        return schema ? JSON.parse(rawText) : rawText;
                    }
                }
                throw new Error("Resposta da IA inv√°lida ou vazia.");
            };

            const generateAndRender = async (buttonId, containerId, group, dataKey, prompt, schema, renderFn) => {
                const button = document.getElementById(buttonId);
                const containerElement = document.getElementById(containerId);
                const contentContainer = containerElement ? containerElement.querySelector('div') : null;

                if (button) {
                    button.disabled = true;
                    button.innerHTML = '<div class="loader"></div><span class="ml-2">Gerando...</span>';
                }
                
                try {
                    const result = await callAIApi('gemini', prompt, schema);
                    group[dataKey] = result;
                    group.updatedAt = new Date().toISOString();
                    if (contentContainer) { renderFn(result, contentContainer); }
                    return result; 
                } catch (error) {
                    console.error(`Error for ${dataKey}:`, error);
                    if (contentContainer) { contentContainer.innerHTML = `<p class="text-red-500">Ocorreu um erro: ${error.message}</p>`; }
                    throw error; 
                } finally {
                    if (button) { button.style.display = 'none'; }
                }
            };

            const handleChatSubmit = async (engine) => {
                const input = document.getElementById(`${engine}-chat-input`);
                const responseContainer = document.getElementById(`${engine}-chat-response`);
                const question = input.value.trim();
                if(!question) return;

                responseContainer.innerHTML = '<div class="flex justify-center items-center h-full"><div class="loader-dark"></div></div>';
                input.disabled = true;

                try {
                    const response = await callAIApi(engine, question);
                    responseContainer.innerHTML = simpleMarkdownToHtml(response);
                } catch(error) {
                    responseContainer.innerText = `Erro: ${error.message}`;
                } finally {
                    input.disabled = false;
                }
            };
            window.handleChatSubmit = handleChatSubmit;

            const renderSalesKit = (kit, container) => {
                if(!kit || !container) return;
                container.innerHTML = `
                    <div class="space-y-4">
                        <div><h4 class="font-semibold text-slate-700">Como a Auto Arremate Pode Ajudar:</h4><p class="text-sm">${kit.valueProposition || 'N/A'}</p></div>
                        <div><h4 class="font-semibold text-slate-700">Script de E-mail:</h4><div class="text-sm border rounded-md p-3 bg-slate-50"><strong>Assunto:</strong> ${kit.emailScript?.subject || 'N/A'}<br><br>${(kit.emailScript?.body || '').replace(/\n/g, '<br>')}</div></div>
                        <div><h4 class="font-semibold text-slate-700">Script de Liga√ß√£o:</h4><div class="text-sm border rounded-md p-3 bg-slate-50">${(kit.callScript || '').replace(/\n/g, '<br>')}</div></div>
                        <div><h4 class="font-semibold text-slate-700">Controle de Obje√ß√µes:</h4><div class="text-sm space-y-2">${(kit.objectionHandling || []).map(o => `<p><strong>Obje√ß√£o:</strong> ${o.objection}<br><strong>Resposta:</strong> ${o.response}</p>`).join('')}</div></div>
                    </div>
                `;
            };
            const generateSalesKit = (group) => {
                const prompt = `You are a sales coach for "Auto Arremate", a B2B platform that helps car dealerships manage and sell trade-in and aged inventory through an efficient digital auction system. Generate a sales kit in PORTUGUESE to approach the group "${group.groupName}". The group's known details are: Main brands: ${group.pdvs?.map(p=>p.name).join(', ') || 'N/A'}. Provide a JSON object with: valueProposition (string), emailScript (object with subject and body), callScript (string), and objectionHandling (array of objects with objection and response for 2 common objections).`;
                 const schema = { type: "OBJECT", properties: { "valueProposition": { "type": "STRING" }, "emailScript": { "type": "OBJECT", "properties": {"subject": {"type": "STRING"}, "body": {"type": "STRING"}} }, "callScript": { "type": "STRING" }, "objectionHandling": { "type": "ARRAY", "items": {"type": "OBJECT", "properties": {"objection": {"type": "STRING"}, "response": {"type": "STRING"}}} } } };
                 generateAndRender('generate-sales-kit-btn', 'sales-kit-container', group, 'salesKit', prompt, schema, renderSalesKit);
            };
            
            const renderStrategicSummary = (summary, container) => { if(container) container.innerHTML = simpleMarkdownToHtml(summary); };
            const generateStrategicSummary = (group) => {
                const prompt = `For the Brazilian automotive group "${group.groupName}", provide a concise strategic summary in PORTUGUESE. Use bold titles for: Profile, Brand Strategy, and Potential Strengths.`;
                generateAndRender('generate-ai-analysis-btn', 'ai-analysis-container', group, 'strategicAnalysis', prompt, null, renderStrategicSummary);
            };
            
            const renderEnrichmentData = (data, container) => {
                if(!container) return;
                container.innerHTML = `
                    <div class="space-y-4 text-sm">
                        <p><strong>Endere√ßo:</strong> ${data.address || 'N√£o encontrado'}</p>
                        <p><strong>Telefone Principal:</strong> ${data.phone || 'N√£o encontrado'}</p>
                        <p><strong>Email Principal:</strong> ${data.primaryEmail || 'N√£o encontrado'}</p>
                        <p><strong>Website:</strong> ${data.website ? `<a href="https://${data.website.replace(/^https?:\/\//,'')}" target="_blank" class="text-blue-600 hover:underline">${data.website}</a>` : 'N√£o encontrado'}</p>
                        <p><strong>Blog:</strong> ${data.blogUrl ? `<a href="${data.blogUrl}" target="_blank" class="text-blue-600 hover:underline">Acessar Blog</a>` : 'N√£o encontrado'}</p>
                        <div>
                            <h4 class="font-semibold text-slate-700 mt-4 mb-2">Decisores Chave:</h4>
                            ${(data.decisionMakers && data.decisionMakers.length > 0) ? `
                                <div class="flow-root"><table class="min-w-full divide-y divide-slate-200"><thead><tr><th class="py-2 pr-3 text-left text-sm font-semibold text-slate-900">Nome</th><th class="px-3 py-2 text-left text-sm font-semibold text-slate-900">Cargo</th><th class="px-3 py-2 text-left text-sm font-semibold text-slate-900">LinkedIn</th></tr></thead><tbody class="divide-y divide-slate-200 bg-white">${data.decisionMakers.map(c => `<tr><td class="py-2 pr-3 font-medium text-slate-800">${c.name}</td><td class="px-3 py-2 text-slate-500">${c.role}</td><td class="px-3 py-2 text-slate-500">${c.linkedin ? `<a href="${c.linkedin}" target="_blank" class="text-blue-600 hover:underline">Ver Perfil</a>` : 'N/A'}</td></tr>`).join('')}</tbody></table></div>` 
                            : '<p>Nenhum contato encontrado.</p>'
                            }
                        </div>
                    </div>
                `;
            };
            const enrichLead = (group) => {
                const prompt = `You are a B2B data enrichment specialist. For the Brazilian automotive group '${group.groupName}', find and return: main physical address, a primary contact phone number, official website, a general contact email, URL of their blog if available, and a list of up to 3 key decision makers (name, role, linkedin URL). Return null for any fields you cannot find. Do not invent data.`;
                const schema = {type: "OBJECT", properties: { "address": { "type": "STRING", "nullable": true }, "phone": { "type": "STRING", "nullable": true }, "website": { "type": "STRING", "nullable": true }, "primaryEmail": { "type": "STRING", "nullable": true }, "blogUrl": { "type": "STRING", "nullable": true }, "decisionMakers": { "type": "ARRAY", items: { "type": "OBJECT", properties: { "name": { "type": "STRING" }, "role": { "type": "STRING" }, "linkedin": { "type": "STRING", "nullable": true } } } } } };
                return generateAndRender('enrich-lead-btn', 'ai-enrichment-container', group, 'enrichmentData', prompt, schema, renderEnrichmentData);
            };
            
            const renderCompetitors = (competitors, container) => {
                 if (competitors?.length > 0) {
                     container.innerHTML = `<div class="flow-root"><table class="min-w-full divide-y divide-slate-200"><thead><tr><th class="py-2 pr-3 text-left text-sm font-semibold text-slate-900">Concorrente</th><th class="px-3 py-2 text-left text-sm font-semibold text-slate-900">Ponto Forte</th></tr></thead><tbody class="divide-y divide-slate-200 bg-white">${competitors.map(c => `<tr><td class="py-2 pr-3 text-sm font-medium text-slate-800">${c.name}</td><td class="px-3 py-2 text-sm text-slate-500">${c.strength}</td></tr>`).join('')}</tbody></table></div>`;
                 } else { container.innerHTML = '<p class="text-slate-500">Nenhum concorrente direto identificado.</p>'; }
            };
            const generateCompetitorAnalysis = (group) => {
                const prompt = `For the automotive group "${group.groupName}", identify its 3 main competitors in its primary city or region in Brazil. For each competitor, state their name and their main strength.`;
                const schema = {type: "ARRAY", items: {type: "OBJECT", properties: { "name": { "type": "STRING" }, "strength": { "type": "STRING" }}, required: ["name", "strength"]}};
                generateAndRender('competitor-analysis-btn', 'ai-competitor-container', group, 'competitorAnalysis', prompt, schema, renderCompetitors);
            };

            const enrichAllLeads = async () => {
                ui.enrichAllBtn.disabled = true; 
                ui.enrichAllBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Enriquecendo...</span>';
                const leadsToEnrich = groupsData.filter(group => !group.enrichmentData);
                
                const enrichmentPromises = leadsToEnrich.map(group => {
                     const prompt = `For the Brazilian automotive group '${group.groupName}', find and return: main physical address, a primary contact phone number, official website, a general contact email, URL of their blog if available, and a list of up to 3 key decision makers (name, role, linkedin URL). Return null for any fields you cannot find.`;
                     const schema = {type: "OBJECT", properties: { "address": { "type": "STRING", "nullable": true }, "phone": { "type": "STRING", "nullable": true }, "website": { "type": "STRING", "nullable": true }, "primaryEmail": { "type": "STRING", "nullable": true }, "blogUrl": { "type": "STRING", "nullable": true }, "decisionMakers": { "type": "ARRAY", items: { "type": "OBJECT", properties: { "name": { "type": "STRING" }, "role": { "type": "STRING" }, "linkedin": { "type": "STRING", "nullable": true } } } } } };
                     return callAIApi('gemini', prompt, schema).then(result => {
                         group.enrichmentData = result;
                     }).catch(err => console.error(`Failed to enrich ${group.groupName}:`, err));
                });

                try {
                    const results = await Promise.allSettled(enrichmentPromises);
                    const fulfilledCount = results.filter(r => r.status === 'fulfilled').length;
                    showToast(`${fulfilledCount} de ${leadsToEnrich.length} grupos foram enriquecidos.`);
                } catch (error) {
                    console.error("Bulk enrichment failed:", error);
                    showToast("Ocorreu um erro durante o enriquecimento em massa.", true);
                } finally {
                    ui.enrichAllBtn.disabled = false;
                    ui.enrichAllBtn.innerHTML = 'üîç Enriquecer Todos os Contatos';
                }
            };

            const generateMarketSummary = async () => {
                ui.marketSummaryBtn.disabled = true; ui.marketSummaryBtn.innerHTML = '<div class="loader"></div><span class="ml-2">Analisando Mercado...</span>';
                const dataSummary = groupsData.map(g => `${g.groupName} (Brands: ${[...new Set(g.pdvs.map(p => p.name.match(/\b(Fiat|Chevrolet|Honda|VW|Volkswagen|Toyota|Nissan|BMW|Mercedes-Benz|Jeep|Renault|Hyundai|Mitsubishi|Ford|RAM|Chery)\b/gi)).filter(Boolean))].join(', ')})`).join('; ');
                const prompt = `Based on this list of Brazilian automotive groups: ${dataSummary}. Provide an executive market summary in PORTUGUESE. Analyze dominant brands, key geographic clusters, and the prevalence of multi-brand strategies.`;
                try {
                    const summary = await callAIApi('gemini', prompt);
                    ui.marketSummaryContainer.innerHTML = simpleMarkdownToHtml(summary);
                    ui.marketSummaryContainer.classList.remove('hidden');
                } catch(error) { showToast(`Erro ao gerar resumo de mercado: ${error.message}`, true); } 
                finally { ui.marketSummaryBtn.style.display = 'none'; }
            };
            
            const consultLeadData = async () => {
                const cnpj = document.getElementById('cnpj-input').value.trim();
                const consultBtn = document.getElementById('consult-cnpj-btn');
                const resultDiv = document.getElementById('consultation-result');

                if (!cnpj) {
                    showToast('Por favor, informe um CNPJ para consulta.', true);
                    return;
                }

                consultBtn.disabled = true;
                consultBtn.innerHTML = '<div class="loader-dark mx-auto"></div>';
                resultDiv.innerHTML = '';

                const prompt = `Simulate a query to a Brazilian company database for CNPJ "${cnpj}". Return a single JSON object with the company's "razaoSocial" (company name), "telefone", "website", and "cnaePrincipal" (primary business activity code, numbers only). If no data is found, return an empty object. Example CNAE: 4511101.`;
                const schema = {type: "OBJECT", properties: { "razaoSocial": { "type": "STRING" }, "telefone": { "type": "STRING" }, "website": { "type": "STRING" }, "cnaePrincipal": { "type": "STRING" } }};

                try {
                    const result = await callAIApi('gemini', prompt, schema);
                    renderConsultationResult(result);
                } catch (error) {
                    console.error('CNPJ consultation error:', error);
                    resultDiv.innerHTML = `<p class="text-red-500">Erro na consulta: ${error.message}</p>`;
                } finally {
                    consultBtn.disabled = false;
                    consultBtn.innerHTML = 'Consultar e Validar';
                }
            };

            const renderConsultationResult = (data) => {
                const resultDiv = document.getElementById('consultation-result');
                if (!data || !data.razaoSocial) {
                    resultDiv.innerHTML = '<p class="text-slate-500">Nenhum lead encontrado para o crit√©rio informado.</p>';
                    return;
                }

                const cnaeCode = (data.cnaePrincipal || '').replace(/[^0-9]/g, '');
                const isApproved = ALLOWED_CNAES.includes(cnaeCode);
                const statusClass = isApproved ? 'text-green-600 bg-green-100' : 'text-red-600 bg-red-100';
                const statusText = isApproved ? 'APROVADO' : 'REPROVADO';
                const meiNote = cnaeCode === '7719599' ? '<p class="text-xs text-amber-600 mt-1">Nota MEI: Verifique se a atividade principal est√° alinhada.</p>' : '';
                
                let resultHTML = `
                    <div class="border rounded-md p-4 space-y-2">
                        <h4 class="font-bold text-lg">${data.razaoSocial}</h4>
                        <p><strong>Telefone:</strong> ${data.telefone || 'N/A'}</p>
                        <p><strong>Website:</strong> ${data.website ? `<a href="https://${data.website.replace(/^https?:\/\//,'')}" target="_blank" class="text-blue-600">${data.website}</a>` : 'N/A'}</p>
                        <p><strong>CNAE Principal:</strong> ${data.cnaePrincipal || 'N/A'}</p>
                        <div>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium ${statusClass}">${statusText}</span>
                            ${meiNote}
                        </div>
                `;

                if (isApproved) {
                    resultHTML += `<div class="pt-2"><button id="add-consulted-lead-btn" class="inline-flex items-center gap-x-2 rounded-md bg-green-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-green-500">Adicionar ao Diret√≥rio</button></div>`;
                } else {
                    resultHTML += `<p class="text-xs text-red-600 mt-2">Este CNAE n√£o est√° na lista de atividades permitidas para compradores B2B.</p>`;
                }

                resultHTML += `</div>`;
                resultDiv.innerHTML = resultHTML;

                if (isApproved) {
                    document.getElementById('add-consulted-lead-btn').addEventListener('click', () => {
                        const newGroup = {
                            id: crypto.randomUUID(),
                            groupName: data.razaoSocial,
                            mainPhone: data.telefone,
                            mainWebsite: data.website,
                            cnae: data.cnaePrincipal,
                            pdvs: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        if (groupsData.some(g => g.groupName.toLowerCase() === newGroup.groupName.toLowerCase())) {
                            showToast('Este grupo j√° existe no diret√≥rio.', true);
                            return;
                        }

                        groupsData.unshift(newGroup);
                        renderGroups(groupsData);
                        prepareChartData();
                        showToast(`Grupo "${newGroup.groupName}" adicionado e qualificado com sucesso!`, false);
                        resultDiv.innerHTML = ''; 
                    });
                }
            };

            const addManualLead = () => {
                const name = document.getElementById('manual-name').value.trim();
                const phone = document.getElementById('manual-phone').value.trim();
                const website = document.getElementById('manual-website').value.trim();

                if (!name) {
                    showToast('O nome do grupo √© obrigat√≥rio.', true);
                    return;
                }

                const newGroup = { 
                    id: crypto.randomUUID(),
                    groupName: name, 
                    mainPhone: phone, 
                    mainWebsite: website, 
                    pdvs: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                if (groupsData.some(g => g.groupName.toLowerCase() === newGroup.groupName.toLowerCase())) {
                    showToast('Este grupo j√° existe no diret√≥rio.', true);
                    return;
                }

                groupsData.unshift(newGroup);
                renderGroups(groupsData);
                prepareChartData();
                showToast(`Grupo "${name}" adicionado com sucesso!`);
                
                document.getElementById('manual-name').value = '';
                document.getElementById('manual-phone').value = '';
                document.getElementById('manual-website').value = '';
            };
            
            // --- Init & Event Listeners ---
            document.getElementById('consult-cnpj-btn').addEventListener('click', consultLeadData);
            document.getElementById('manual-add-btn').addEventListener('click', addManualLead);
            if (ui.enrichAllBtn) ui.enrichAllBtn.addEventListener('click', enrichAllLeads);
            if (ui.marketSummaryBtn) ui.marketSummaryBtn.addEventListener('click', generateMarketSummary);
            if (ui.searchInput) ui.searchInput.addEventListener('input', (e) => { renderGroups(groupsData.filter(g => g.groupName.toLowerCase().includes(e.target.value.toLowerCase()))); });
            if (ui.modalContainer) ui.modalContainer.addEventListener('click', (e) => { if(e.target === ui.modalContainer) { closeModal(); } });
            
            setupTabs('#lead-management-tabs .tab-button', '.dashboard-card .tab-content');

            const createChart = (canvasId, type, data, options) => {
                const chartElement = document.getElementById(canvasId);
                if(!chartElement) return;
                if (chartElement.chart) { chartElement.chart.destroy(); }
                const ctx = chartElement.getContext('2d');
                chartElement.chart = new Chart(ctx, { type, data, options });
            }

            const prepareChartData = () => {
                const groupsWithPdvCount = groupsData.map(g => ({ name: g.groupName, count: g.pdvs.filter(p => p.phone || p.website).length })).filter(g => g.count > 0).sort((a, b) => b.count - a.count).slice(0, 15);
                const barChartData = { labels: groupsWithPdvCount.map(g => g.name), datasets: [{ label: 'N¬∫ de PDVs', data: groupsWithPdvCount.map(g => g.count), backgroundColor: 'rgba(59, 130, 246, 0.7)'}] };
                createChart('pdvCountChart', 'bar', barChartData, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: {display: false} } });

                const brandKeywords = ['Fiat', 'Chevrolet', 'Honda', 'VW', 'Toyota', 'Nissan', 'BMW', 'Mercedes-Benz', 'Jeep', 'Renault', 'Hyundai', 'Mitsubishi', 'Ford', 'RAM', 'Chery'];
                const brandCounts = {};
                groupsData.forEach(group => { const text = group.groupName + ' ' + group.pdvs.map(p => p.name).join(' '); const found = new Set(); brandKeywords.forEach(brand => { if (text.toLowerCase().includes(brand.toLowerCase())) { found.add(brand === 'Volkswagen' ? 'VW' : brand); } }); found.forEach(brand => { brandCounts[brand] = (brandCounts[brand] || 0) + 1; }) });
                const sortedBrands = Object.entries(brandCounts).sort(([,a],[,b]) => b-a).slice(0, 10);
                const doughnutData = { labels: sortedBrands.map(b => b[0]), datasets: [{ data: sortedBrands.map(b => b[1]), backgroundColor: [ 'rgba(59, 130, 246, 0.8)', 'rgba(239, 68, 68, 0.8)', 'rgba(245, 158, 11, 0.8)', 'rgba(16, 185, 129, 0.8)', 'rgba(139, 92, 246, 0.8)', 'rgba(236, 72, 153, 0.8)', 'rgba(96, 165, 250, 0.8)', 'rgba(248, 113, 113, 0.8)', 'rgba(251, 191, 36, 0.8)', 'rgba(52, 211, 153, 0.8)' ] }]};
                createChart('brandDistChart', 'doughnut', doughnutData, { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } });
            };

            renderGroups(groupsData);
            prepareChartData();
        });
    </script>
</body>
</html>
